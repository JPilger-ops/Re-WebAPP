<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Einstellungen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    /* Dezente, schlichte Seite nur für Bank/Kategorien */
    .page-stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
    }
    .settings-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 0 auto 6px;
      max-width: 1100px;
      padding: 0 2px;
    }
    .settings-tab {
      border: 1px solid #e5e7eb;
      background: #f8fafc;
      color: #111;
      border-radius: 999px;
      padding: 8px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,0.04);
    }
    .settings-tab:hover {
      background: #eef2ff;
      border-color: #d7def5;
    }
    .settings-tab.active {
      background: linear-gradient(90deg, #0ea5e9, #22c55e);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 12px 24px rgba(14,165,233,0.22);
    }
    .tab-panel.hidden {
      display: none !important;
    }
    .soft-card { border-radius: 16px; box-shadow: 0 10px 28px rgba(0,0,0,0.04); border: 1px solid #e5e7eb; background: #fff; padding: 16px; }
    .section-title { font-size: 22px; font-weight: 700; margin: 0; }
    .pill { background: #f2f2f7; color: #111; border-radius: 999px; padding: 6px 12px; font-size: 12px; }
    .input-stack { display: grid; gap: 12px; }
    .two-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .tiny-note { font-size: 12px; color: #6b7280; }
    .inline-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .dropzone-clean { border: 1px dashed #cbd5e1; border-radius: 12px; padding: 14px; text-align: center; background: #f8fafc; cursor: pointer; transition: 150ms ease; }
    .dropzone-clean:hover { border-color: #a0aec0; background: #f1f5f9; }
    .spacer-8 { height: 8px; }
    .table-top { display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 999; }
    .modal-card { background: #fff; border-radius: 16px; padding: 16px; width: min(640px, 90vw); box-shadow: 0 20px 50px rgba(0,0,0,0.12); }
    .modal-head { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 10px; }
    .ghost-btn { background: #f5f5f7; border: 1px solid #e5e7eb; border-radius: 999px; padding: 6px 10px; cursor: pointer; }
    .hidden { display: none !important; }
    .placeholder-pills { display: flex; flex-wrap: wrap; gap: 8px; margin: 6px 0 4px; }
    .placeholder-pill { border: 1px solid #e5e7eb; background: #f8fafc; border-radius: 999px; padding: 6px 10px; font-size: 12px; cursor: grab; }
    .placeholder-pill:active { cursor: grabbing; }
    .drop-hint { font-size: 12px; color: #6b7280; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-title">RechnungsAPP</div>
      <nav class="sidebar-nav">
        <button class="nav-item" id="nav-dashboard">Dashboard</button>
        <button class="nav-item" id="nav-invoices">Rechnungsübersicht</button>
        <button class="nav-item" id="nav-statistics">Statistik</button>
        <button class="nav-item" id="nav-create">Neue Rechnung</button>
        <button class="nav-item" id="nav-customers">Kundenverwaltung</button>
        <button id="nav-users" class="nav-item">Benutzerverwaltung</button>
        <button id="nav-account" class="nav-item">Account</button>
        <button id="nav-roles" class="nav-item">Rollenverwaltung</button>
        <button id="nav-categories" class="nav-item nav-item-active">Einstellungen</button>
        <button id="nav-logout" class="nav-item" style="color:#b20000;">Logout</button>
      </nav>
    </aside>

    <main class="main">
      <header class="topbar">
        <div>
          <div class="chip">Einstellungen</div>
          <h1 class="topbar-title">Bank & Kategorien</h1>
          <div class="muted">Passe Rechnungs-Fußzeile, SEPA-Daten und Kategorien zentral an.</div>
        </div>
      </header>

      <div class="settings-tabs">
        <button class="settings-tab active" data-tab="bank">Bank</button>
        <button class="settings-tab" data-tab="categories">Kategorien</button>
        <button class="settings-tab" data-tab="datev">DATEV</button>
        <button class="settings-tab" data-tab="cert">Zertifikate</button>
      </div>

      <div class="tab-panel" data-tab-panel="bank">
        <div class="page-stack">
          <section class="soft-card">
            <div class="inline-buttons" style="justify-content: space-between; align-items: flex-start;">
              <div>
                <div class="pill">Bankdaten</div>
                <h2 class="section-title">SEPA & Fußzeile</h2>
                <div class="muted">Wird im PDF und SEPA-QR-Code genutzt.</div>
              </div>
              <div class="inline-buttons">
                <button id="bank-reload" class="secondary-button small-btn">Zurücksetzen</button>
                <button id="bank-save" class="primary-button small-btn">Speichern</button>
              </div>
            </div>

            <div id="bank-error" class="error-box hidden"></div>
            <div id="bank-success" class="success-box hidden"></div>

            <div class="input-stack">
              <label class="input-label">Kontoinhaber</label>
              <input id="bank-holder" class="input" type="text" placeholder="z. B. Waldwirtschaft Heidekönig" />

              <label class="input-label">Bankname</label>
              <input id="bank-name" class="input" type="text" placeholder="z. B. VR-Bank Bonn Rhein-Sieg eG" />

              <div class="two-col">
                <div>
                  <label class="input-label">IBAN</label>
                  <input id="bank-iban" class="input" type="text" placeholder="DE00 0000 0000 0000 0000 00" />
                </div>
                <div>
                  <label class="input-label">BIC</label>
                  <input id="bank-bic" class="input" type="text" placeholder="GENODEXX" />
                </div>
              </div>
              <div class="tiny-note">Die Angaben werden automatisch in neue Rechnungen und den SEPA-QR-Code übernommen.</div>
            </div>
          </section>
        </div>
      </div>

      <div class="tab-panel hidden" data-tab-panel="categories">
        <div class="page-stack">
          <section class="soft-card" style="display:flex; flex-direction:column; gap:16px;">
            <div>
              <div class="pill">Kategorien & Logos</div>
              <h2 class="section-title">Logos pflegen, Labels vergeben</h2>
            </div>

            <div id="error-box" class="error-box hidden"></div>
            <div id="cat-success" class="success-box hidden"></div>

            <!-- Neu anlegen -->
            <div class="cat-form">
              <div class="input-stack">
                <div class="pill" style="align-self:flex-start;">Neu anlegen</div>
                <div id="logo-dropzone" class="dropzone-clean">
                  <input type="file" id="logo-file" accept=".png,.jpg,.jpeg,.svg" hidden />
                  <div class="mini-title" style="margin-bottom:4px;">Logo hochladen</div>
                  <div class="tiny-note">PNG, JPG oder SVG · max. 1.5 MB</div>
                  <div class="spacer-8"></div>
                  <div class="settings-note" id="logo-file-name">Keine Datei ausgewählt</div>
                  <div class="spacer-8"></div>
                  <button id="logo-file-btn" class="secondary-button small-btn" type="button">Datei auswählen</button>
                  <div class="tiny-note" style="margin-top:6px;">Upload speichert sofort und taucht in der Liste auf.</div>
                </div>

                <div class="two-col">
                  <div>
                    <label class="input-label">Key (z. B. GESELLSCHAFTEN)</label>
                    <input id="cat-key" class="input" type="text" />
                    <div class="tiny-note" id="cat-key-hint">Großbuchstaben/Unterstriche werden automatisch gesetzt.</div>
                  </div>
                  <div>
                    <label class="input-label">Label (Anzeige)</label>
                    <input id="cat-label" class="input" type="text" />
                    <div class="tiny-note">So erscheint die Kategorie in Rechnungen.</div>
                  </div>
                </div>

                <div>
                  <label class="input-label">Logo-Datei</label>
                  <select id="cat-logo" class="input select-input">
                    <option value="" selected disabled>Logo auswählen...</option>
                  </select>
                  <div class="tiny-note">Dateiname aus <code>/public/logos/</code>. Upload fügt neue hinzu.</div>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                  <button id="cat-add" class="primary-button">Kategorie speichern</button>
                  <div class="tiny-note">Speichern fügt die Kategorie unten hinzu.</div>
                </div>
              </div>
            </div>

            <!-- Bestehende Kategorien -->
            <div class="cat-table-card">
              <div class="table-top">
                <div>
                  <div class="pill">Bestehende Kategorien</div>
                  <div class="tiny-note">Werte direkt anpassen und je Zeile speichern.</div>
                </div>
                <div class="inline-buttons">
                  <button id="cat-refresh" class="secondary-button small-btn">Neu laden</button>
                </div>
              </div>
              <div class="table-wrapper">
                  <table class="table">
                    <thead>
                      <tr>
                        <th style="width: 18%;">Key</th>
                        <th>Label</th>
                        <th>Logo-Datei</th>
                        <th>E-Mail</th>
                        <th style="width: 90px;">Vorschau</th>
                        <th style="width: 180px;">Aktionen</th>
                      </tr>
                    </thead>
                    <tbody id="cat-body"></tbody>
                </table>
              </div>
          </section>
        </div>
      </div>

      <div class="tab-panel hidden" data-tab-panel="datev">
        <div class="page-stack">
          <section class="soft-card">
            <div class="inline-buttons" style="justify-content: space-between; align-items: flex-start;">
              <div>
                <div class="pill">DATEV</div>
                <h2 class="section-title">Export-E-Mail</h2>
                <div class="muted">Adresse, an die Rechnungen für DATEV gesendet werden.</div>
              </div>
              <div class="inline-buttons">
                <button id="datev-reload" class="secondary-button small-btn">Neu laden</button>
                <button id="datev-save" class="primary-button small-btn">Speichern</button>
              </div>
            </div>

            <div id="datev-error" class="error-box hidden"></div>
            <div id="datev-success" class="success-box hidden"></div>

            <div class="input-stack">
              <label class="input-label">DATEV E-Mail</label>
              <input id="datev-email" class="input" type="email" placeholder="buchhaltung@steuerkanzlei.de" />
              <div class="tiny-note">Wird für den Button „DATEV EXPORT“ und „Senden + DATEV“ genutzt.</div>
            </div>
          </section>
        </div>
      </div>

      <div class="tab-panel hidden" data-tab-panel="cert">
        <div class="page-stack">
          <section class="soft-card" style="max-width: 560px;">
            <div class="pill">TLS / Client</div>
            <h2 class="section-title" style="margin:6px 0;">CA-Zertifikat herunterladen</h2>
            <div class="muted" style="margin-bottom:12px;">Nur für Admins sichtbar. Zertifikat für Client-SSL (ca.crt).</div>
            <button id="ca-download" class="primary-button small-btn">ca.crt herunterladen</button>
            <div class="tiny-note" style="margin-top:10px;">Lege das Zertifikat auf Clients als vertrauenswürdige Stamm-CA ab.</div>
          </section>
        </div>
      </div>
    </main>
  </div>

  <script src="/nav.js?v=3"></script>
  <script src="/categories.js?v=5"></script>

  <!-- Modals -->
  <div id="email-modal" class="modal-backdrop hidden">
      <div class="modal-card">
        <div class="modal-head">
          <div>
            <div class="pill">E-Mail-Konto</div>
            <h3 class="section-title" id="email-modal-title">Kategorie</h3>
        </div>
        <button class="ghost-btn" id="email-modal-close">Schließen</button>
      </div>
      <div id="email-error" class="error-box hidden"></div>
      <div id="email-success" class="success-box hidden"></div>

      <div class="input-stack">
        <label class="input-label">Absendername</label>
        <input id="email-display" class="input" type="text" />

        <label class="input-label">E-Mail-Adresse</label>
        <input id="email-address" class="input" type="email" />

        <div class="pill" style="align-self:flex-start;">SMTP</div>
        <div class="two-col">
          <input id="smtp-host" class="input" placeholder="smtp.ionos.de" />
          <input id="smtp-port" class="input" placeholder="465" type="number" />
        </div>
        <label><input id="smtp-secure" type="checkbox" checked /> SSL/TLS</label>
        <input id="smtp-user" class="input" placeholder="user@domain.de" />
        <input id="smtp-pass" class="input" type="password" placeholder="Passwort" />
      </div>

      <div class="inline-buttons" style="justify-content: flex-end; margin-top:12px;">
        <button id="email-test" class="secondary-button small-btn">Testen</button>
        <button id="email-save" class="primary-button small-btn">Speichern</button>
      </div>
      <div id="email-test-result" class="tiny-note" style="margin-top:8px;"></div>
    </div>
  </div>

  <div id="template-modal" class="modal-backdrop hidden">
    <div class="modal-card">
      <div class="modal-head">
        <div>
          <div class="pill">E-Mail-Template</div>
          <h3 class="section-title" id="template-modal-title">Kategorie</h3>
        </div>
        <button class="ghost-btn" id="template-modal-close">Schließen</button>
      </div>
      <div id="template-error" class="error-box hidden"></div>
      <div id="template-success" class="success-box hidden"></div>

      <label class="input-label">Betreff</label>
      <input id="tpl-subject" class="input" type="text" />

      <label class="input-label">Inhalt</label>
      <textarea id="tpl-body" class="input" rows="10" placeholder="Hallo {{recipient_name}}, ..."></textarea>
      <div class="tiny-note">Verfügbare Platzhalter:</div>
      <div id="placeholder-list" class="placeholder-pills"></div>
      <div class="drop-hint">Ziehe oder klicke einen Platzhalter in Betreff/Body.</div>

      <div class="inline-buttons" style="justify-content: flex-end; margin-top:12px;">
        <button id="tpl-preview" class="secondary-button small-btn">Preview</button>
        <button id="tpl-save" class="primary-button small-btn">Speichern</button>
      </div>
    </div>
  </div>
</body>
</html>
